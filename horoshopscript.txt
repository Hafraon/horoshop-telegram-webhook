<script>
(function () {
  const ENDPOINT = "https://horoshop-telegram-webhook-production.up.railway.app/api/telegram-webhook";
  const SECRET = "#3kMt3Iy39s*iMXdocj3pombAki6kg&B";
  
  console.log("üöÄ Webhook —Å–∫—Ä–∏–ø—Ç –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ!");
  
  const once = (key) => {
    try {
      if (sessionStorage.getItem(key)) return false;
      sessionStorage.setItem(key, "1");
      return true;
    } catch { return true; }
  };

  function send(payload) {
    try {
      console.log("üì§ –í—ñ–¥–ø—Ä–∞–≤–ª—è—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä:", payload);
      fetch(ENDPOINT, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Secret": SECRET
        },
        body: JSON.stringify(payload),
        keepalive: true
      })
      .then(r => {
        console.log("‚úÖ –í—ñ–¥–ø–æ–≤—ñ–¥—å —Å–µ—Ä–≤–µ—Ä–∞:", r.status);
        return r.json();
      })
      .catch(e => console.warn("‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏:", e));
    } catch (e) { 
      console.error("üí• –ü–æ–º–∏–ª–∫–∞ send():", e);
    }
  }

  function fromDataLayer() {
    console.log("üîç –®—É–∫–∞—é –ø–æ–∫—É–ø–∫–∏ –≤ dataLayer...");
    const dl = (window.dataLayer || []).slice().reverse();
    console.log("üìä dataLayer –º–∞—î", dl.length, "–µ–ª–µ–º–µ–Ω—Ç—ñ–≤");
    
    const hit = dl.find(x => {
      const isPurchase = x?.event === "purchase" || x?.ecommerce?.purchase;
      if (isPurchase) {
        console.log("‚úÖ –ó–Ω–∞–π—à–æ–≤ –ø–æ–¥—ñ—é –ø–æ–∫—É–ø–∫–∏:", x);
      }
      return isPurchase;
    });
    
    if (!hit) {
      console.log("‚ùå –ü–æ–∫—É–ø–∫—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ dataLayer");
      return;
    }

    const ec = hit.ecommerce?.purchase || hit.ecommerce || {};
    const id = ec.actionField?.id || ec.transaction_id || "";
    const revenue = ec.actionField?.revenue || ec.value || ec.revenue || "";
    const currency = ec.currencyCode || ec.currency || "UAH";
    const items = (ec.products || ec.items || []).map(p => ({
      title: p.name || p.item_name || "–¢–æ–≤–∞—Ä",
      quantity: p.quantity || p.item_quantity || 1,
      price: p.price || p.item_price || ""
    }));

    console.log("üì¶ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è ID:", id, "–°—É–º–∞:", revenue);
    
    if (id && once("order_"+id)) {
      console.log("üöÄ –í—ñ–¥–ø—Ä–∞–≤–ª—è—é –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è...");
      send({
        event: "order_created_client",
        order: { id, number: id, total: revenue, currency, items }
      });
    } else {
      console.log("‚ö†Ô∏è  ID –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∏–π –∞–±–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤–∂–µ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ");
    }
  }

  document.addEventListener("submit", function (e) {
    const f = e.target;
    if (!f || !(f instanceof HTMLFormElement)) return;

    const idn = (f.id + " " + f.name + " " + (f.getAttribute("action") || "")).toLowerCase();
    const isCallback = /(callback|call|phone|fastorder|quickorder|–¥–∑–≤—ñ–Ω–æ–∫)/i.test(idn);

    if (isCallback) {
      const fd = new FormData(f);
      const name = fd.get("name") || fd.get("client_name") || "";
      const phone = fd.get("phone") || fd.get("client_phone") || "";
      const email = fd.get("email") || "";

      if (phone) {
        send({
          event: "callback_request_client",
          name: name || "‚Äî",
          phone: phone,
          email: email || "‚Äî",
          page: location.href
        });
      }
    }
  }, true);

  window.addEventListener("load", () => {
    console.log("‚è±Ô∏è  window.load –∑–∞–ø—É—â–µ–Ω–æ, —á–µ—Ä–µ–∑ 800ms –±—É–¥—É —à—É–∫–∞—Ç–∏ –ø–æ–∫—É–ø–∫–∏");
    setTimeout(fromDataLayer, 800);
  });
})();
</script>